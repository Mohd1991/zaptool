<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tic Tac Toe - Real Multiplayer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .board {
            display: grid;
            grid-template-columns: repeat(3, 100px);
            grid-template-rows: repeat(3, 100px);
            gap: 5px;
            margin: 20px 0;
        }
        .cell {
            width: 100px;
            height: 100px;
            background-color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 48px;
            cursor: pointer;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .cell:hover {
            background-color: #f0f0f0;
        }
        .status {
            font-size: 20px;
            margin-bottom: 20px;
            font-weight: bold;
            text-align: center;
            min-height: 60px;
        }
        .online-controls {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 400px;
            margin-bottom: 20px;
        }
        .online-controls input, .online-controls button {
            margin: 5px 0;
            padding: 10px;
            font-size: 16px;
        }
        .online-controls button {
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .online-controls button:hover {
            background-color: #0b7dda;
        }
        .team-info {
            margin-top: 10px;
            padding: 10px;
            background-color: #e9e9e9;
            border-radius: 5px;
        }
        .reset-btn {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
        .reset-btn:hover {
            background-color: #d32f2f;
        }
        .highlight {
            background-color: #a5d6a7 !important;
        }
        .disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .waiting-message {
            text-align: center;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>Tic Tac Toe - Real Multiplayer</h1>
    
    <div class="game-container" id="game-container">
        <div class="online-controls" id="online-controls">
            <div id="create-section">
                <input type="text" id="team-name" placeholder="Enter game name" value="My Game">
                <button id="create-team-btn">Create Game</button>
            </div>
            <div id="join-section">
                <input type="text" id="join-code" placeholder="Enter game code">
                <button id="join-team-btn">Join Game</button>
            </div>
            <div class="team-info" id="team-info" style="display: none;">
                <p>Game: <span id="display-team-name"></span></p>
                <p>Code: <span id="display-team-code"></span></p>
                <p>Status: <span id="team-status">Waiting for opponent...</span></p>
            </div>
        </div>
        
        <div class="status" id="status"></div>
        
        <div class="board" id="board" style="display: none;">
            <div class="cell" data-index="0"></div>
            <div class="cell" data-index="1"></div>
            <div class="cell" data-index="2"></div>
            <div class="cell" data-index="3"></div>
            <div class="cell" data-index="4"></div>
            <div class="cell" data-index="5"></div>
            <div class="cell" data-index="6"></div>
            <div class="cell" data-index="7"></div>
            <div class="cell" data-index="8"></div>
        </div>
        
        <button class="reset-btn" id="reset-btn" style="display: none;">Play Again</button>
    </div>
    
    <script>
        // Game state
        let currentPlayer = 'X';
        let gameBoard = ['', '', '', '', '', '', '', '', ''];
        let gameActive = false;
        let mySymbol = '';
        let gameId = '';
        let playerId = '';
        let teamName = '';
        
        // Simulated WebSocket using localStorage
        const CHANNEL = 'tic_tac_toe_multiplayer';
        let isHost = false;
        
        // DOM elements
        const gameContainer = document.getElementById('game-container');
        const statusDisplay = document.getElementById('status');
        const board = document.getElementById('board');
        const onlineControls = document.getElementById('online-controls');
        const createTeamBtn = document.getElementById('create-team-btn');
        const joinTeamBtn = document.getElementById('join-team-btn');
        const teamNameInput = document.getElementById('team-name');
        const joinCodeInput = document.getElementById('join-code');
        const teamInfo = document.getElementById('team-info');
        const displayTeamName = document.getElementById('display-team-name');
        const displayTeamCode = document.getElementById('display-team-code');
        const teamStatusDisplay = document.getElementById('team-status');
        const resetBtn = document.getElementById('reset-btn');
        const createSection = document.getElementById('create-section');
        const joinSection = document.getElementById('join-section');
        
        // Initialize simulated WebSocket
        function setupLocalStorageListener() {
            window.addEventListener('storage', (event) => {
                if (event.key === CHANNEL && event.newValue) {
                    const data = JSON.parse(event.newValue);
                    if (data.gameId === gameId) {
                        handleMessage(data);
                    }
                }
            });
        }
        
        function sendMessage(data) {
            localStorage.setItem(CHANNEL, JSON.stringify(data));
            localStorage.removeItem(CHANNEL); // Trigger event
        }
        
        // Handle incoming messages
        function handleMessage(data) {
            switch (data.type) {
                case 'game_created':
                    handleGameCreated(data);
                    break;
                case 'player_joined':
                    handlePlayerJoined(data);
                    break;
                case 'move':
                    handleMoveReceived(data);
                    break;
                case 'restart':
                    handleRestartReceived(data);
                    break;
                case 'player_left':
                    handlePlayerLeft();
                    break;
            }
        }
        
        function handleGameCreated(data) {
            gameId = data.gameId;
            playerId = data.playerId;
            mySymbol = 'X';
            teamName = data.teamName;
            isHost = true;
            
            displayTeamName.textContent = teamName;
            displayTeamCode.textContent = gameId;
            teamStatusDisplay.textContent = 'Waiting for opponent...';
            
            teamInfo.style.display = 'block';
            createSection.style.display = 'none';
            statusDisplay.textContent = 'Waiting for an opponent to join...';
        }
        
        function handlePlayerJoined(data) {
            gameId = data.gameId;
            playerId = data.playerId;
            mySymbol = 'O';
            teamName = data.teamName;
            isHost = false;
            
            displayTeamName.textContent = teamName;
            displayTeamCode.textContent = gameId;
            teamStatusDisplay.textContent = 'Game ready!';
            
            teamInfo.style.display = 'block';
            joinSection.style.display = 'none';
            board.style.display = 'grid';
            
            gameActive = true;
            currentPlayer = 'X';
            
            updateStatus();
            
            // Notify host that we joined
            sendMessage({
                type: 'player_joined_ack',
                gameId,
                playerId,
                teamName
            });
        }
        
        function handleMoveReceived(data) {
            // Update game board
            gameBoard = data.board;
            updateBoard();
            
            // Update game state
            currentPlayer = data.currentPlayer;
            
            if (data.status === 'finished') {
                gameActive = false;
                if (data.winner === 'draw') {
                    statusDisplay.textContent = 'Game ended in a draw!';
                } else if (data.winner === mySymbol) {
                    statusDisplay.textContent = 'You won!';
                } else {
                    statusDisplay.textContent = 'You lost!';
                }
                resetBtn.style.display = 'block';
                highlightWinningCells(data.board);
            } else {
                updateStatus();
            }
        }
        
        function handleRestartReceived(data) {
            gameBoard = data.board;
            currentPlayer = data.currentPlayer;
            gameActive = true;
            
            updateBoard();
            updateStatus();
            resetBtn.style.display = 'none';
            
            // Remove highlights
            document.querySelectorAll('.cell').forEach(cell => {
                cell.classList.remove('highlight');
            });
        }
        
        function handlePlayerLeft() {
            gameActive = false;
            statusDisplay.textContent = 'Opponent disconnected. Waiting for them to reconnect...';
        }
        
        // Event listeners
        createTeamBtn.addEventListener('click', createGame);
        joinTeamBtn.addEventListener('click', joinGame);
        resetBtn.addEventListener('click', requestRestart);
        
        // Initialize cells
        document.querySelectorAll('.cell').forEach(cell => {
            cell.addEventListener('click', handleCellClick);
        });
        
        // Game functions
        function createGame() {
            const name = teamNameInput.value.trim();
            if (!name) {
                alert('Please enter a game name');
                return;
            }
            
            gameId = generateGameCode();
            playerId = generatePlayerId();
            teamName = name;
            
            sendMessage({
                type: 'game_created',
                gameId,
                playerId,
                teamName: name
            });
            
            // Handle our own message (since storage event won't fire for same tab)
            handleGameCreated({
                gameId,
                playerId,
                teamName: name
            });
        }
        
        function joinGame() {
            const code = joinCodeInput.value.trim().toUpperCase();
            if (!code) {
                alert('Please enter a game code');
                return;
            }
            
            playerId = generatePlayerId();
            gameId = code;
            
            sendMessage({
                type: 'player_joined',
                gameId,
                playerId
            });
            
            // Handle our own message
            handlePlayerJoined({
                gameId,
                playerId,
                teamName: 'Game ' + code // Default name
            });
        }
        
        function handleCellClick(e) {
            if (!gameActive) return;
            if (currentPlayer !== mySymbol) return;
            
            const cell = e.target;
            const cellIndex = parseInt(cell.getAttribute('data-index'));
            
            if (gameBoard[cellIndex] !== '') return;
            
            // Make move
            gameBoard[cellIndex] = mySymbol;
            cell.textContent = mySymbol;
            
            // Check for winner
            const winner = checkWinner(gameBoard);
            const isDraw = checkDraw(gameBoard);
            
            sendMessage({
                type: 'move',
                gameId,
                index: cellIndex,
                symbol: mySymbol,
                board: gameBoard,
                currentPlayer: mySymbol === 'X' ? 'O' : 'X',
                status: winner || isDraw ? 'finished' : 'active',
                winner: winner || (isDraw ? 'draw' : null)
            });
            
            // Handle our own message
            handleMoveReceived({
                board: gameBoard,
                currentPlayer: mySymbol === 'X' ? 'O' : 'X',
                status: winner || isDraw ? 'finished' : 'active',
                winner: winner || (isDraw ? 'draw' : null)
            });
        }
        
        function requestRestart() {
            sendMessage({
                type: 'restart',
                gameId,
                board: ['', '', '', '', '', '', '', '', ''],
                currentPlayer: 'X'
            });
            
            // Handle our own message
            handleRestartReceived({
                board: ['', '', '', '', '', '', '', '', ''],
                currentPlayer: 'X'
            });
        }
        
        function updateBoard() {
            document.querySelectorAll('.cell').forEach((cell, index) => {
                cell.textContent = gameBoard[index];
            });
        }
        
        function updateStatus() {
            if (currentPlayer === mySymbol) {
                statusDisplay.textContent = 'Your turn (' + mySymbol + ')';
            } else {
                statusDisplay.textContent = 'Waiting for opponent...';
            }
        }
        
        function highlightWinningCells(board) {
            const winPatterns = [
                [0, 1, 2], [3, 4, 5], [6, 7, 8], // rows
                [0, 3, 6], [1, 4, 7], [2, 5, 8], // columns
                [0, 4, 8], [2, 4, 6]             // diagonals
            ];
            
            for (const pattern of winPatterns) {
                const [a, b, c] = pattern;
                if (board[a] && board[a] === board[b] && board[a] === board[c]) {
                    document.querySelector(`.cell[data-index="${a}"]`).classList.add('highlight');
                    document.querySelector(`.cell[data-index="${b}"]`).classList.add('highlight');
                    document.querySelector(`.cell[data-index="${c}"]`).classList.add('highlight');
                    return;
                }
            }
        }
        
        function checkWinner(board) {
            const winPatterns = [
                [0, 1, 2], [3, 4, 5], [6, 7, 8], // rows
                [0, 3, 6], [1, 4, 7], [2, 5, 8], // columns
                [0, 4, 8], [2, 4, 6]             // diagonals
            ];
            
            for (const pattern of winPatterns) {
                const [a, b, c] = pattern;
                if (board[a] && board[a] === board[b] && board[a] === board[c]) {
                    return board[a];
                }
            }
            
            return null;
        }
        
        function checkDraw(board) {
            return board.every(cell => cell !== '');
        }
        
        function generateGameCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }
        
        function generatePlayerId() {
            return Math.random().toString(36).substr(2, 9);
        }
        
        // Initialize
        setupLocalStorageListener();
    </script>
</body>
</html>
